[
  {
    "field": "organismId",
    "pipeline": [
      {
        "$match": {
          "$or": [
            {
              "public": true,
              "binned": false,
              "analysis.speciator.organismId": {
                "$in": [
                  "1280",
                  "1336",
                  "1646",
                  "2697049",
                  "485",
                  "573",
                  "64320",
                  "90370"
                ]
              }
            },
            {
              "_user": "5b7fe3c6073810a16ff7e71a",
              "binned": false,
              "analysis.speciator.organismId": {
                "$in": [
                  "1280",
                  "1336",
                  "1646",
                  "2697049",
                  "485",
                  "573",
                  "64320",
                  "90370"
                ]
              }
            }
          ]
        }
      },
      {
        "$group": {
          "_id": {
            "label": "$analysis.speciator.organismName",
            "key": "$analysis.speciator.organismId"
          },
          "count": {
            "$sum": 1
          }
        }
      }
    ]
  },
  {
    "field": "genusId",
    "pipeline": [
      {
        "$match": {
          "$or": [
            {
              "public": true,
              "binned": false,
              "analysis.speciator.genusId": {
                "$exists": true
              }
            },
            {
              "_user": "5b7fe3c6073810a16ff7e71a",
              "binned": false,
              "analysis.speciator.genusId": {
                "$exists": true
              }
            }
          ]
        }
      },
      {
        "$group": {
          "_id": {
            "label": "$analysis.speciator.genusName",
            "key": "$analysis.speciator.genusId"
          },
          "count": {
            "$sum": 1
          }
        }
      }
    ]
  },
  {
    "field": "country",
    "pipeline": [
      {
        "$group": {
          "_id": "$country",
          "count": {
            "$sum": 1
          }
        }
      }
    ]
  },
  {
    "field": "access",
    "pipeline": [
      {
        "$group": {
          "_id": {
            "$cond": [
              {
                "$and": [
                  {
                    "$eq": [
                      "$reference",
                      true
                    ]
                  },
                  {
                    "$in": [
                      "$analysis.speciator.organismId",
                      [
                        "485",
                        "573",
                        "1280",
                        "1336",
                        "1646",
                        "64320",
                        "90370",
                        "2697049"
                      ]
                    ]
                  }
                ]
              },
              "reference",
              {
                "$cond": [
                  {
                    "$eq": [
                      "$public",
                      true
                    ]
                  },
                  "public",
                  "private"
                ]
              }
            ]
          },
          "count": {
            "$sum": 1
          }
        }
      }
    ]
  },
  {
    "field": "uploadedAt",
    "pipeline": [
      {
        "$match": {
          "$or": [
            {
              "public": true,
              "binned": false,
              "_user": "5b7fe3c6073810a16ff7e71a"
            },
            {
              "_user": "5b7fe3c6073810a16ff7e71a",
              "binned": false
            }
          ]
        }
      },
      {
        "$group": {
          "_id": {
            "$dateToString": {
              "date": "$uploadedAt",
              "format": "%Y-%m-%dT%H:%M:%S.%LZ"
            }
          },
          "count": {
            "$sum": 1
          }
        }
      }
    ]
  },
  {
    "field": "date",
    "pipeline": [
      {
        "$match": {
          "$or": [
            {
              "public": true,
              "binned": false
            },
            {
              "_user": "5b7fe3c6073810a16ff7e71a",
              "binned": false
            }
          ]
        }
      },
      {
        "$group": {
          "_id": "date",
          "max": {
            "$max": "$date"
          },
          "min": {
            "$min": "$date"
          }
        }
      },
      {
        "$project": {
          "_id": 0
        }
      }
    ]
  },
  {
    "field": "resistance",
    "pipeline": [
      {
        "$project": {
          "antibiotics": {
            "$filter": {
              "input": "$analysis.paarsnp.resistanceProfile",
              "as": "ab",
              "cond": {
                "$eq": [
                  "$$ab.state",
                  "RESISTANT"
                ]
              }
            }
          }
        }
      },
      {
        "$unwind": "$antibiotics"
      },
      {
        "$group": {
          "_id": "$antibiotics.agent.name",
          "count": {
            "$sum": 1
          }
        }
      }
    ]
  },
  {
    "field": "subspecies",
    "pipeline": [
      {
        "$match": {
          "$or": [
            {
              "public": true,
              "binned": false,
              "$or": [
                {
                  "analysis.serotype": {
                    "$exists": true
                  }
                },
                {
                  "analysis.speciator.organismId": "2697049"
                }
              ]
            },
            {
              "_user": "5b7fe3c6073810a16ff7e71a",
              "binned": false,
              "$or": [
                {
                  "analysis.serotype": {
                    "$exists": true
                  }
                },
                {
                  "analysis.speciator.organismId": "2697049"
                }
              ]
            }
          ]
        }
      },
      {
        "$group": {
          "_id": {
            "$ifNull": [
              "$analysis.serotype.subspecies",
              "$analysis.speciator.organismName"
            ]
          },
          "count": {
            "$sum": 1
          }
        }
      }
    ]
  }
]
