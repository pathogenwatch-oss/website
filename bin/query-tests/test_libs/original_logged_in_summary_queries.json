[
  {
    "name": "organismId",
    "pipeline": [
      {
        "$match": {
          "$or": [
            {
              "public": true
            },
            {
              "_user": "5b7fe3c6073810a16ff7e71a"
            }
          ],
          "binned": false
        }
      },
      {
        "$match": {
          "analysis.speciator.organismId": {
            "$in": [
              "1280",
              "1336",
              "1646",
              "2697049",
              "485",
              "573",
              "64320",
              "90370"
            ]
          }
        }
      },
      {
        "$group": {
          "_id": {
            "label": "$analysis.speciator.organismName",
            "key": "$analysis.speciator.organismId"
          },
          "count": {
            "$sum": 1
          }
        }
      }
    ]
  },
  {
    "name": "genusId",
    "pipeline": [
      {
        "$match": {
          "$or": [
            {
              "public": true
            },
            {
              "_user": "5b7fe3c6073810a16ff7e71a"
            }
          ],
          "binned": false
        }
      },
      {
        "$match": {
          "analysis.speciator.genusId": {
            "$exists": true
          }
        }
      },
      {
        "$group": {
          "_id": {
            "label": "$analysis.speciator.genusName",
            "key": "$analysis.speciator.genusId"
          },
          "count": {
            "$sum": 1
          }
        }
      }
    ]
  },
  {
    "name": "country",
    "pipeline": [
      {
        "$match": {
          "$or": [
            {
              "public": true
            },
            {
              "_user": "5b7fe3c6073810a16ff7e71a"
            }
          ],
          "binned": false
        }
      },
      {
        "$group": {
          "_id": "$country",
          "count": {
            "$sum": 1
          }
        }
      }
    ]
  },
  {
    "name": "access",
    "pipeline": [
      {
        "$match": {
          "$or": [
            {
              "public": true
            },
            {
              "_user": "5b7fe3c6073810a16ff7e71a"
            }
          ],
          "binned": false
        }
      },
      {
        "$group": {
          "_id": {
            "$cond": [
              {
                "$and": [
                  {
                    "$eq": [
                      "$reference",
                      true
                    ]
                  },
                  {
                    "$in": [
                      "$analysis.speciator.organismId",
                      [
                        "485",
                        "573",
                        "1280",
                        "1336",
                        "1646",
                        "64320",
                        "90370",
                        "2697049"
                      ]
                    ]
                  }
                ]
              },
              "reference",
              {
                "$cond": [
                  {
                    "$eq": [
                      "$public",
                      true
                    ]
                  },
                  "public",
                  "private"
                ]
              }
            ]
          },
          "count": {
            "$sum": 1
          }
        }
      }
    ]
  },
  {
    "name": "uploadedAt",
    "pipeline": [
      {
        "$match": {
          "$or": [
            {
              "public": true
            },
            {
              "_user": "5b7fe3c6073810a16ff7e71a"
            }
          ],
          "binned": false
        }
      },
      {
        "$match": {
          "_user": "5b7fe3c6073810a16ff7e71a"
        }
      },
      {
        "$group": {
          "_id": {
            "$dateToString": {
              "date": "$uploadedAt",
              "format": "%Y-%m-%dT%H:%M:%S.%LZ"
            }
          },
          "count": {
            "$sum": 1
          }
        }
      }
    ]
  },
  {
    "name": "date",
    "pipeline": [
      {
        "$match": {
          "$or": [
            {
              "public": true
            },
            {
              "_user": "5b7fe3c6073810a16ff7e71a"
            }
          ],
          "binned": false
        }
      },
      {
        "$group": {
          "_id": "date",
          "max": {
            "$max": "$date"
          },
          "min": {
            "$min": "$date"
          }
        }
      },
      {
        "$project": {
          "_id": 0
        }
      }
    ]
  },
  {
    "name": "resistance",
    "pipeline": [
      {
        "$match": {
          "$or": [
            {
              "public": true
            },
            {
              "_user": "5b7fe3c6073810a16ff7e71a"
            }
          ],
          "binned": false
        }
      },
      {
        "$project": {
          "antibiotics": {
            "$filter": {
              "input": "$analysis.paarsnp.resistanceProfile",
              "as": "ab",
              "cond": {
                "$eq": [
                  "$$ab.state",
                  "RESISTANT"
                ]
              }
            }
          }
        }
      },
      {
        "$unwind": "$antibiotics"
      },
      {
        "$group": {
          "_id": "$antibiotics.agent.name",
          "count": {
            "$sum": 1
          }
        }
      }
    ]
  },
  {
    "name": "subspecies",
    "pipeline": [
      {
        "$match": {
          "$or": [
            {
              "public": true
            },
            {
              "_user": "5b7fe3c6073810a16ff7e71a"
            }
          ],
          "binned": false
        }
      },
      {
        "$match": {
          "$or": [
            {
              "analysis.serotype": {
                "$exists": true
              }
            },
            {
              "analysis.speciator.organismId": "2697049"
            }
          ]
        }
      },
      {
        "$group": {
          "_id": {
            "$ifNull": [
              "$analysis.serotype.subspecies",
              "$analysis.speciator.organismName"
            ]
          },
          "count": {
            "$sum": 1
          }
        }
      }
    ]
  }
]
